#cloud-config

runcmd:
  # Update Apt and fetch required tools.
  - apt-get -y update
  - apt-get -y install git bash
  - apt-get -y install build-essential
  # Ensure environment is setup.
  - export HOME=/root
  # Fetch and install Chef.
  - curl -L https://omnitruck.chef.io/install.sh | sudo bash
  - /opt/chef/embedded/bin/gem install berkshelf
  # Install a deployment key for the 41h cookbook.
  - mkdir /root/.ssh/
  - echo -n 'LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBMFVqeE43ME9qTStHWUdTRWpSTWNBekVwbThCN21jQWR6V09XbTFPUWs2enVnSEpBCjcyZVhsWjIvMTBWR1ZwUFFGNEJxamMzZkZrM3Y5VUdNemFxWGtBbXpJLzdwUURCeWJzNlZMS2ZkUGluVzBSeDgKMzAwL3RyaGxpS0RBVDJFMDBBdFAzeG9QTzdDaCtpVDU3dDRZN3MxSUN0SDZoREhLbzVmaWg2cDZqa1JkUnJBLwpVbXBpS2FHVUJqWUEvTVlkQVdvSEJJendvbTIySlA4WEtMTDRaMjllc1RqbnRwVGZMTmtibUZzbDdQNzFsckpUCjhNRmY0Q1hlTEdtQ255UkYxakh6cmxYOGRKOEtZaElYbm95ZkpnamZMWVNDdGs4TVN4NFNaaVBMbnVBVDZkMGkKanp6anNVRVV4Vis1Z0JpRW5kTXRVR3drODVqaFpkWko5RmFhRVFJREFRQUJBb0lCQUVKNjJ6VUxkeDIvcGozawpjRDZuL1ZQK1ArdGIzMmRkb1pubXNxYXdpdEorTWx6VzdrMmVLSWE4VDM1QVlUR0xUcVRJaEJCN2Z3d0V3ZDYwCmJkZS9BdG9jV3ExcWdnbUQyalhjcFlKRDZJR2dwTDVVUUU1bXFZQ1BYcUZoL3ZTNE9pQ0VGMkVWVkJWdjdHUWIKYnRFejk5T1RuZmpoN3FRamRPMDJpQnowU0czOE1sNnk3Vmo1clY0OUxad2x1aUtSTTFUMUhJV3FTR2h3Qk9oaQp5dXc0bTFBN3dWbTZEWSs2T1FqYlF1VGIwRnM1K1IyUXJrVEF6NWFoVlp2SjVhQk15WEc5ZTBtbHMzbzJUYkUzCllUUEpRNzJzQVNXMUdIUnpPdHlMK2pNZStaYkJNSEM3UjdZdlR4QzdrTTNBOFVHUVdKdGlJSFJUNjBsLytsNlEKbG9wRy82a0NnWUVBNkpCeHdsbTJDd0MvL3hnUmRqeDl4QkZ5bzlOcWVsZStXYnhGYTl1REgveTErTzNuK3JZTQo4VG51OU5lb2R6UTBmZTdLQ01OZ2dPbGdVaHRNY2FXLzN5azA0QXpXRitWYVo3R3NGRWVSYUUvMi9yb1JPb2p0ClY4cDFDZ1lLZmczcTN2RSs4NnFpRnV4QjFxaU1zOCsrdkxrWWJid2h0NmlQYUNMZm82UHU3SHNDZ1lFQTVsL3oKdUxZMnlJb2VtZ0ZDc041THF6b3ZsMlZKNzBrdDlISGd3ZmI5aUJVTXdJV0V1czduR1dzQkJ1YmlTQ0NHVm1rTQpJUnFNOXNjbGFYbEdrRkh0QmtLb0trcncxdlhOdVdVemZkcHVXRkpsYWJDS0FVRGpmeUxaR3VHWTBJN0lzNVVqCllSN25uZEdoY2tqNVRZV2l1WTcxK1JNZUw5YnY4bFRueC85UzYrTUNnWUJ5ejZ4NWlCUnBCaXZDNGJ6dEpCdnEKaWJxUXlqU014WGlCa0lLdEpxZHJTVFVFK1Y1RzFVMDZZYUZvV25jZXNqVWYzcHo3Q29rLzJ2YmtVZm5CT1ZTcAo5UXZYZUQ3UmVUYlNibEpIaUxWdVM5dmlFVFdrTWlrSjZEY3poWnYwY3laNmZaclliR3FzNm1IdWVUTk5LY2crCkh4ckNRZGhiZE9tblBXQXV4eVdTdFFLQmdBa1J0ZktMbWRTRE8za3NtNGVDK00rZzFzYkxBZ0lkaTJXWUpoVDgKdURablBiMUdoRmNtVmdxMkg3QTUzcWFnUVNtZHNSQ01qd2dZQnUwRURUY1pRbytBaUVaQjlRRkJZL3ZzYy81OApYdU96T3JMU2RGeGdSWlIzdHJ4TUxVdm9reFlleE9uSjRheGcyRTQ3ZVRVSUVjUGtVT0toVWdyb0YwSWUvWkR1CkNFR3BBb0dBSFY0eHh3SlJGaFRsYkE1NXVzb05SSDZzZGJJRFFvVlcvb1R0R0ZjQWljZnRwb0ZvTWUrZkZ0QlEKdERTVFRwTlZiQzlrc3h0NHpiTmYwZU1zOXpzQ3NHMmZtU2Y3NlRMTGxWR3dsSjZkVjh4M0ViV3R0K1RHa2czdgpJWUZkOHNnSFJ3Yy95aVRHTXpnS0xSeFRyT1hDWDJFYnJacW1lUGpxTDNtVEluUWxaSjQ9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==' | base64 -d > /root/.ssh/41h-startup.pem
  - chmod 600 /root/.ssh/41h-startup.pem
  # Check-out the environment cookbook.
  - GIT_SSH_COMMAND="ssh -i /root/.ssh/41h-startup.pem -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" git clone git@github.com:darkarnium/41h.git /tmp/provisioning
  # Create the Chef zero repository.
  - cd /tmp/provisioning/41h
  - /opt/chef/embedded/bin/berks vendor
  - mkdir /tmp/chef
  - mv ./berks-cookbooks /tmp/chef/cookbooks
  - cd /tmp/chef/cookbooks
  # Kick off chef.
  - echo '{}' > /tmp/chef/chef.json
  - chmod 600 /tmp/chef/chef.json
  - chef-client -z -o '41h::default,41h::nginx' -j /tmp/chef/chef.json
